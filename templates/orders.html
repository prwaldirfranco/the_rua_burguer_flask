<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pedidos - THE RUA BURGUER</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body { background:#121212; color:#fff; padding:28px; }
    .card { background:#1f1f1f; border:1px solid #333; border-radius:10px; padding:18px; }
    .table thead th { border-bottom: 1px solid #333; color:#ddd; }
    .btn-add { background:#ffcc00; color:#000; font-weight:600; }
    .btn-add:hover { background:#ffdb4d; }
    .order-list { background:#181818; border-radius:10px; padding:15px; margin-top:18px; }
    .muted { color:#aaa; font-size:0.9rem; }
    .small-muted { color:#999; font-size:0.85rem; }
    .modal-content { background:#141414; color:#fff; border:1px solid #222; }
    .form-control, .form-select { background:#1b1b1b; color:#fff; border:1px solid #333; }
    .form-control::placeholder { color:#777; }
    .cart-item { border-bottom:1px dashed #2b2b2b; padding:10px 0; }
    .total-box { background:#111; border:1px solid #222; padding:10px; border-radius:8px; }
    .btn-back { background:#333; color:#fff; border:1px solid #555; }
    .btn-back:hover { background:#444; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Cabeçalho com Botão Voltar -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>Pedidos - THE RUA BURGUER</h2>
      <a href="/pdv" class="btn btn-back btn-sm">
        Voltar para PDV
      </a>
    </div>

    <p id="cashStatus" class="muted">Verificando status do caixa...</p>

    <!-- Produtos -->
    <div class="card mt-3">
      <h5>Produtos</h5>
      <div class="table-responsive">
        <table class="table table-dark table-borderless align-middle" id="productsTable">
          <thead>
            <tr><th>Produto</th><th>Categoria</th><th>Preço</th><th style="width:120px">Ação</th></tr>
          </thead>
          <tbody id="productsBody">
            <tr><td colspan="4" class="text-center small-muted">Carregando produtos...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Carrinho -->
    <div class="order-list mt-4">
      <div class="d-flex justify-content-between align-items-center">
        <h5>Novo Pedido</h5>
        <div>
          <label class="me-2 small-muted">Tipo:</label>
          <select id="orderType" class="form-select d-inline-block" style="width:180px;">
            <option value="local">Comer no local</option>
            <option value="retirada">Retirada</option>
            <option value="entrega">Entrega</option>
          </select>
        </div>
      </div>

      <div id="cartItems" class="mt-3"></div>

      <div class="row mt-3 g-3">
        <div class="col-md-4">
          <label class="form-label small-muted">Nome do cliente</label>
          <input id="orderCustomer" class="form-control" placeholder="Ex: João Silva" />
        </div>
        <div class="col-md-4">
          <label class="form-label small-muted">Endereço (entrega)</label>
          <input id="orderAddress" class="form-control" placeholder="Rua, número..." />
        </div>
        <div class="col-md-4">
          <label class="form-label small-muted">Telefone</label>
          <input id="orderPhone" class="form-control" placeholder="(11) 9xxxx-xxxx" />
        </div>
        <div class="col-md-12">
          <label class="form-label small-muted">Observação geral</label>
          <input id="orderNote" class="form-control" placeholder="Ex: Sem maionese..." />
        </div>
      </div>

      <div class="d-flex justify-content-between align-items-center mt-3">
        <div class="total-box">
          <div class="small-muted">Resumo</div>
          <div id="summaryItems" class="mt-2 small-muted"></div>
          <div class="mt-2"><strong>Total:</strong> R$ <span id="cartTotal">0.00</span></div>
        </div>
        <div class="text-end">
          <button id="btnClearCart" class="btn btn-outline-light me-2">Limpar</button>
          <button id="btnSendOrder" class="btn btn-add">Enviar pedido</button>
        </div>
      </div>
    </div>

    <!-- Lista de pedidos criados -->
    <div class="card mt-4">
      <h5>Pedidos criados</h5>
      <div class="table-responsive">
        <table class="table table-dark table-sm align-middle">
          <thead>
            <tr>
              <th>ID</th><th>Cliente</th><th>Tipo</th><th>Total</th><th>Status</th><th>Ação</th>
            </tr>
          </thead>
          <tbody id="ordersTableBody">
            <tr><td colspan="6" class="text-center small-muted">Carregando pedidos...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_BASE = '/api';
    let products = [];
    let cart = [];

    function money(v){ return Number(v).toFixed(2); }

    // === LIBERAR PEDIDO ===
    async function liberarPedido(orderId){
      try {
        const res = await fetch(`${API_BASE}/orders/release/${orderId}`, {method:'POST'});
        const js = await res.json();
        if(js.success){
          alert(`Pedido #${orderId} liberado!`);
          loadOrders();
        } else {
          alert('Erro: ' + (js.message || 'Falha ao liberar'));
        }
      } catch(e) {
        alert('Erro de conexão.');
      }
    }

    // === CARREGAR PEDIDOS ===
    async function loadOrders(){
      try {
        const res = await fetch(`${API_BASE}/orders`);
        const js = await res.json();
        const orders = js.orders || [];
        const tbody = document.getElementById('ordersTableBody');
        tbody.innerHTML = '';
        if(!orders.length){
          tbody.innerHTML = '<tr><td colspan="6" class="text-center small-muted">Nenhum pedido</td></tr>';
          return;
        }
        orders.forEach(o => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>#${o.id}</td>
            <td>${o.customer_name || '-'}</td>
            <td>${o.type}</td>
            <td>R$ ${money(o.total)}</td>
            <td><span class="badge bg-info">${o.status}</span></td>
            <td>
              ${o.status === 'aguardando liberação'
                ? `<button class="btn btn-warning btn-sm" onclick="liberarPedido(${o.id})">Liberar</button>`
                : '<span class="text-muted">—</span>'
              }
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch(e) {
        console.error(e);
      }
    }

    // === ENVIAR PEDIDO ===
    document.getElementById('btnSendOrder').addEventListener('click', async () => {
      if(!cart.length) return alert('Carrinho vazio!');

      const customer = document.getElementById('orderCustomer').value.trim();
      const type = document.getElementById('orderType').value;
      const address = document.getElementById('orderAddress').value.trim();
      const phone = document.getElementById('orderPhone').value.trim();
      const note = document.getElementById('orderNote').value.trim();

      if(!customer) return alert('Informe o nome do cliente.');
      if(type === 'entrega' && (!address || !phone)) return alert('Endereço e telefone obrigatórios para entrega.');

      const items = cart.map(item => ({
        product_id: item.product.id,
        product_name: item.product.name,
        price: item.product.price,
        options_removed: item.options_removed || [],
        extras: item.extras || [],
        note: item.note || '',
        total: item.total
      }));

      const total = cart.reduce((s, i) => s + i.total, 0);

      const payload = {
        customer_name: customer,
        type,
        address: type === 'entrega' ? address : null,
        phone: type === 'entrega' ? phone : null,
        note: note || null,
        items,
        total
      };

      try {
        const res = await fetch(`${API_BASE}/orders/new`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        const js = await res.json();
        if(js.success){
          alert(`Pedido #${js.order.id} criado com sucesso!`);
          cart = [];
          renderCartItems();
          updateSummary();
          loadOrders();
        } else {
          alert('Erro: ' + (js.message || 'Falha ao enviar'));
        }
      } catch(e) {
        console.error(e);
        alert('Erro de conexão com o servidor.');
      }
    });

    // === FUNÇÕES DO CARRINHO (simplificadas para exemplo) ===
    function renderCartItems() {
      const container = document.getElementById('cartItems');
      container.innerHTML = cart.length ? '' : '<p class="text-muted small">Carrinho vazio.</p>';
      cart.forEach((item, i) => {
        const div = document.createElement('div');
        div.className = 'cart-item';
        div.innerHTML = `
          <div class="d-flex justify-content-between">
            <div><strong>${item.product.name}</strong></div>
            <div>R$ ${money(item.total)} <button class="btn btn-sm btn-outline-danger" onclick="cart.splice(${i},1); renderCartItems(); updateSummary();">X</button></div>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function updateSummary() {
      const total = cart.reduce((s, i) => s + i.total, 0);
      document.getElementById('cartTotal').textContent = money(total);
      document.getElementById('summaryItems').textContent = cart.map(i => i.product.name).join(', ') || 'Nenhum item';
    }

    document.getElementById('btnClearCart').addEventListener('click', () => {
      if(confirm('Limpar carrinho?')) {
        cart = [];
        renderCartItems();
        updateSummary();
      }
    });

    // === INICIAR PÁGINA ===
    async function initPage(){
      await loadOrders();
      setInterval(loadOrders, 8000);
    }
    initPage();
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Entregas - THE RUA BURGUER</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    :root {
      --primary: #ffcc00;
      --primary-hover: #ffdb4d;
      --dark: #121212;
      --card-bg: #1f1f1f;
      --border: #333;
      --text: #f8f9fa;
    }
    body {
      background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
      color: var(--text);
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 40px 20px;
    }
    h2 {
      font-weight: 800;
      font-size: 2.4rem;
      background: linear-gradient(90deg, #ffcc00, #ff9900);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 1.5rem;
    }
    .card-delivery {
      background-color: var(--card-bg);
      border: 1.5px solid var(--border);
      border-radius: 16px;
      padding: 1.6rem;
      margin-bottom: 1.2rem;
      box-shadow: 0 6px 16px rgba(0,0,0,0.4);
      transition: all 0.3s ease;
    }
    .card-delivery:hover {
      transform: translateY(-6px);
      border-color: var(--primary);
      box-shadow: 0 12px 25px rgba(255,204,0,0.2);
    }
    .delivery-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem; }
    .delivery-id { font-weight: 700; font-size: 1.3rem; color: var(--primary); }
    .delivery-time { font-size: 0.9rem; color: #aaa; }
    .items-list { font-size: 1rem; margin: 0.8rem 0; color: #ddd; }
    .info-row { display: flex; flex-wrap: wrap; gap: 1rem; margin: 0.8rem 0; font-size: 0.95rem; }
    .info-item { display: flex; align-items: center; gap: 0.4rem; color: #bbb; }
    .info-item i { color: var(--primary); }
    .total-price { font-weight: 600; color: #fff; font-size: 1.1rem; }
    .status-badge { font-weight: 600; font-size: 0.9rem; padding: 0.35rem 0.7rem; border-radius: 50px; }
    .status-pronto { background: #28a745; color: white; }
    .status-entrega { background: #ffc107; color: #000; }
    .btn-deliver {
      background-color: #28a745; color: white; border: none; border-radius: 10px;
      padding: 0.6rem 1.2rem; font-weight: 600; font-size: 0.95rem; transition: all 0.2s;
    }
    .btn-deliver:hover { background-color: #218838; transform: translateY(-1px); }
    .empty-state { text-align: center; padding: 3rem 1rem; color: #777; }
    .empty-state i { font-size: 3.5rem; color: #444; margin-bottom: 1rem; }
    .spinner { display: inline-block; width: 18px; height: 18px; border: 2px solid #444; border-top: 2px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @media (max-width: 576px) { h2 { font-size: 2rem; } .card-delivery { padding: 1.2rem; } .delivery-id { font-size: 1.1rem; } }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="text-center mb-4">Painel do Entregador</h2>
    <p id="status" class="text-center text-info fs-5 mb-4">
      <span class="spinner"></span> Carregando entregas...
    </p>
    <div id="deliveryList"></div>
    <div class="mt-4 text-center">
      <a href="/" class="btn btn-outline-light px-4">Voltar</a>
    </div>
  </div>

  <script>
    const API = '/api'; // CORRIGIDO: usa caminho relativo

    const formatTime = iso => iso ? new Date(iso).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : '--:--';
    const formatMoney = v => `R$ ${parseFloat(v || 0).toFixed(2).replace('.', ',')}`;

    async function loadDeliveries() {
      const container = document.getElementById('deliveryList');
      const statusEl = document.getElementById('status');

      try {
        const res = await fetch(`${API}/deliveries`, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const deliveries = data.deliveries || [];

        container.innerHTML = '';
        statusEl.innerHTML = `<i class="bi bi-bicycle text-success"></i> ${deliveries.length} pedido(s) pronto(s) para entrega`;

        if (!deliveries.length) {
          container.innerHTML = `
            <div class="empty-state">
              <i class="bi bi-emoji-smile-upside-down"></i>
              <p class="mb-0">Nenhum pedido pronto para entrega</p>
              <small class="text-muted">Aguardando a cozinha finalizar...</small>
            </div>
          `;
          return;
        }

        deliveries.forEach(order => {
          const items = order.items.length ? order.items.join(', ') : 'Itens n√£o informados';
          const status = order.status === 'pronto para entrega' ? 'Pronto para entrega' : 'Em entrega';
          const badgeClass = order.status === 'pronto para entrega' ? 'status-pronto' : 'status-entrega';

          const card = document.createElement('div');
          card.className = 'card-delivery';
          card.innerHTML = `
            <div class="delivery-header">
              <div class="delivery-id">#${order.id}</div>
              <div class="delivery-time">${formatTime(order.created_at)}</div>
            </div>
            <div class="items-list">${items}</div>
            <div class="info-row">
              <div class="info-item"><i class="bi bi-telephone"></i> ${order.phone}</div>
              <div class="info-item"><i class="bi bi-geo-alt"></i> ${order.address}</div>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-3">
              <div><span class="total-price">${formatMoney(order.total)}</span></div>
              <div><span class="status-badge ${badgeClass}">${status}</span></div>
            </div>
            ${order.status === 'pronto para entrega' ? `
              <div class="text-end mt-3">
                <button class="btn-deliver" onclick="markDelivered(${order.id})">
                  Marcar como Entregue
                </button>
              </div>
            ` : ''}
          `;
          container.appendChild(card);
        });
      } catch (err) {
        console.error('Erro:', err);
        statusEl.innerHTML = `<span class="text-danger">Erro ao conectar</span>`;
        container.innerHTML = `<p class="text-danger text-center">Falha ao carregar. Verifique o servidor.</p>`;
      }
    }

    async function markDelivered(id) {
      if (!confirm(`Marcar Pedido #${id} como ENTREGUE?`)) return;
      try {
        const res = await fetch(`${API}/deliveries/${id}/delivered`, { method: 'POST' });
        const data = await res.json();
        if (data.success) {
          alert(`Pedido #${id} marcado como ENTREGUE!`);
          loadDeliveries();
        } else {
          throw new Error(data.message);
        }
      } catch (err) {
        alert('Erro: ' + (err.message || 'Falha'));
      }
    }

    // Atualiza a cada 8 segundos
    loadDeliveries();
    setInterval(loadDeliveries, 8000);
  </script>
</body>
</html>